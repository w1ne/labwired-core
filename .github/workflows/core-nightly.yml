name: Rust Core Nightly

on:
  schedule:
    - cron: '0 2 * * *' # 2 AM UTC
  workflow_dispatch:

jobs:
  validation:
    name: Advanced Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install ARM Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi

      - name: Install ARM and RISC-V targets
        run: |
          rustup target add thumbv7m-none-eabi
          rustup target add thumbv7em-none-eabihf
          rustup target add thumbv6m-none-eabi
          rustup target add riscv32i-unknown-none-elf

      - name: Build Firmware Fixtures
        run: |
          cargo build -p demo-blinky --release --target thumbv7m-none-eabi
          cargo build -p firmware-h563-demo --release --target thumbv7em-none-eabihf
          cargo build -p firmware-ci-fixture --release --target thumbv6m-none-eabi
          cargo build -p riscv-ci-fixture --release --target riscv32i-unknown-none-elf

      - name: Run ignored H563 CLI integration test
        run: cargo test -p labwired-cli --test h5_demo -- --ignored

      - name: Unsupported Instruction Audit
        run: ./scripts/unsupported_instruction_audit.sh --firmware target/thumbv7m-none-eabi/release/demo-blinky --system configs/systems/ci-fixture-uart1.yaml --max-steps 20000 --out-dir out/unsupported-audit/ci-fixture --fail-on-unsupported

      - name: Digital Twin Verification
        run: ./scripts/digital_twin_verification.sh out/digital-twin-verification

      - name: Trace Drift Assertions
        run: ./scripts/trace_drift_assert.sh --out-dir out/trace-drift-assert

      - name: Upload Validation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-validation-artifacts
          path: |
            out/unsupported-audit/
            out/digital-twin-verification/
            out/trace-drift-assert/
